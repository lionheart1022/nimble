    },
    close: function(e) {
      e && e.preventDefault();
      vc_am.current_form = false;
      this.remove();
    }
  });
  var ComplexShortcodeView = Backbone.View.extend({
    _$widget_title: false,
    _$form_view: false,
    edit_view: false,
    tagName: 'li',
    className: 'widget',
    events: {
      'click .vc_automapper-edit-btn': 'edit',
      'click h4, .widget-action': 'edit'
    },
    template_html: $('#vc_automapper-item-complex-tpl').html() || '<span>{{ tag }}</span>',
    header_template_html: '<h4>{{ name }}<span class="in-widget-title"></span></h4>',
    initialize: function() {
      _.bindAll(this, 'removeEditForm');
      // this.listenTo(this.model, 'change', this.renderTitle);
      this.listenTo(this.model, 'destroy', this.removeView);
      this.model.view = this;
    },
    render: function() {
      this.$el.html(_.template(this.template_html, this.model.toJSON(), template_options)).attr('data-item-id', this.model.get('id'));
      return this;
    },
    renderTitle: function() {
      this.$widgetTitle().html(_.template(this.header_template_html, this.model.toJSON(), template_options));
    },
    edit: function(e) {
      e && e.preventDefault();
      if(this.$editForm().is(':animated')) return false;
      this.$el.addClass('vc_opened');
      if(this.edit_view) {
        this.close();
      } else {
        this.edit_view = new EditFormInnerView({model: this.model}).render();
      }
    },
    $widgetTitle: function() {
      if(!this._$widget_title) this._$widget_title = this.$el.find('.widget-title');
      return this._$widget_title;
    },
    $editForm: function() {
      if(!this._$edit_form) this._$edit_form = this.$el.find('.widget-inside');
      return this._$edit_form;
    },
    removeEditForm: function() {
      this.edit_view && this.edit_view.remove();
      this.edit_view = false;
    },
    beforeSave: function() {
      this.$el.find('#vc_atm-name').val($('#vc_atm-header-name').val());
    },
    close: function() {
      vc_am.current_form = false;
      this.$el.removeClass('vc_opened');
      this.renderTitle();
      this.$editForm().slideUp(100, this.removeEditForm);
    },
    clear: function(e) {
      e && e.preventDefault();
      this.model.destroy();
    },
    removeView: function() {
      this.remove();
    }
  });

  var AddFormView = FormView.extend({
    className: 'vc_add-form-atm',
    template_html: $('#vc_automapper-add-form-tpl').html(),
    events: {
      'click #vc_atm-parse-string': 'parseShortcode',
      'click .vc_atm-cancel': 'close'
    },
    getType: function() {
      return 'create';
    },
    render: function() {
      AddFormView.__super__.render.call(this);
      this.$el.html(_.template(this.template_html, {}, template_options));
      this.$el.insertAfter('.vc_automapper-toolbar');
      return this;
    },
    parseShortcode: function(e) {
      e && e.preventDefault && e.preventDefault();
      var string = $('#vc_atm-shortcode-string').val(), matches, data, params = [], attr;
      if(_.isEmpty(string)) return alert(window.i18nLocaleVcAutomapper.error_enter_valid_shortcode);
      matches = string.match(regexp_shortcode());
      if(!matches) return alert(window.i18nLocaleVcAutomapper.error_enter_valid_shortcode);
      attr = wp.shortcode.attrs(matches[3]);
      _.each(attr.named, function(value, key){
        params.push({param_name: key, type: "textfield", heading: to_title(key), description: 'Example: ' + value , value: value});
      }, this);
      if(matches[5]) params.push({param_name: 'content', type: "textarea", heading: 'Content', description: '', value: matches[5]});
      data = {
        tag: matches[2],
        name: to_title(matches[2]),
        category: window.i18nLocaleVcAutomapper.my_shortcodes_category,
        params: params
      };
      if(this.isValid(data)) {
        vc_am.shortcodes.create(data);
        show_message(window.i18nLocaleVcAutomapper.new_shortcode_mapped, 'success');
        // new EditFormView({model: vc_am.shortcodes.last()}).render();
        vc_am.shortcodes.last().view.edit();
      }  else {
        alert(this.validationError);
      }
    }
  });
  var EditFormView = FormView.extend({
    className: 'vc_edit-form',
    active_preview: false,
    events: {
      'click #vc_atm-save': 'save',
      'click .vc_atm-cancel': 'close',
      'click .vc_atm-delete': 'clear',
      'click #vc_atm-add-param': 'addParam',
      'click .vc_delete-param': 'deleteParam',
      'change #vc_atm-is-container': 'setContentParam',
      'keyup .vc_param-name, .vc_param-value, #vc_atm-tag': 'setPreview',
      'focus #vc_atm-tag': 'setTagFieldActive',
      'focus .vc_params input, .vc_params textarea': 'setParamFieldActive',
      'focus .vc_param.vc_content input, .vc_param.vc_content textarea': 'setContentParamFieldActive',
      'blur #vc_atm-tag, vc_param input': 'unsetFieldActive'
    },
    new: false,
    template_html: $('#vc_automapper-form-tpl').html(),
    param_template_html: $('#vc_atm-form-param-tpl').html(),
    getType: function() {
      return 'edit';
    },
    render: function() {
      EditFormView.__super__.render.call(this);
      this.$el.html(_.template(this.template_html, this.model.toJSON(), template_options));
      this.$el.insertAfter($('[data-item-id=' + this.model.id +']').hide());
      this.addAllParams();
      return this;
    },
    setTagFieldActive: function(e) {
      this.active_preview && $(this.active_preview).removeClass('vc_active');
      this.active_preview = '#vc_shortcode-preview .vc_preview-tag';
      $(this.active_preview).addClass('vc_active');
    },
    setParamFieldActive: function(e) {
      var $control = $(e.currentTarget),
          index = $control.parents('.vc_param:first').index();
      this.active_preview && $(this.active_preview).removeClass('vc_active');
      this.active_preview = '#vc_shortcode-preview .vc_preview-param:eq(' + index + ')';
      $(this.active_preview).addClass('vc_active');
    },
    setContentParamFieldActive: function(e) {
      this.active_preview && $(this.active_preview).removeClass('vc_active');
      this.active_preview = '#vc_shortcode-preview .vc_preview-content';
      $(this.active_preview).addClass('vc_active');
    },
    unsetFieldActive: function(e) {
      $(this.active_preview).removeClass('vc_active');
      this.active_preview = false;
    },
    /***
     * Escape double quotes in params value.
     * @param value
     * @return {*}
     */
    escapeParam:function (value) {
      return value.replace(/"/g, '``');
    },
    getPreview: function(data) {
      var params = data.params,
          content = false,
          params_to_string = {};
      _.each(params, function (value, key) {
        if (value.param_name !== 'content') {
          params_to_string[value.param_name] = this.escapeParam(value.value);
        } else {
          content = value.value;
        }

      }, this);

      return wp.shortcode.atmPreview({
            tag: data.tag,
            attrs: params_to_string,
            content: content,
            type: content === false ? 'single' : ''
          });
    },
    setPreview: function() {
      var data = {
        params: this.getParams(),
        tag: $('#vc_atm-tag').val()
      };
      $('#vc_shortcode-preview').html(this.getPreview(data));
      this.active_preview && $(this.active_preview).addClass('vc_active');
    },
    save: function(e) {
      e && e.preventDefault && e.preventDefault();
      this.$el.find('.vc_error').removeClass('vc_error');
      var data = {
        tag: $('#vc_atm-tag').val(),
        name: $('#vc_atm-name').val(),
        category: $('#vc_atm-category').val(),
        description: $('#vc_atm-description').val(),
        params: this.getParams()
        };
      if(this.isValid(data)) {
          this.model.save(data);
          show_message(window.i18nLocaleVcAutomapper.shortcode_updated, 'success');
        this.close();
      } else {
        alert(this.validationError);
      }
    },
    validate: function(attrs) {
      var result = false, added_param_names = {};
      if(!attrs.name) {
        $('#vc_atm-name').addClass('vc_error');
        return window.i18nLocaleVcAutomapper.error_shortcode_name_is_required;
      }
      if (!attrs.tag || !attrs.tag.match(/^\S+$/)) {
        $('#vc_atm-tag').addClass('vc_error');
        return window.i18nLocaleVcAutomapper.error_enter_valid_shortcode_tag;
      }
      var fields_required = ['param_name', 'heading', 'type'];
      _.each(attrs.params, function(param, index){
        if(param.param_name === 'content' && !$('#vc_atm-params-list [name=param_name]:eq(' + index +')').data('system')) {
          result = window.i18nLocaleVcAutomapper.error_content_param_not_manually;
          $('#vc_atm-params-list [name=param_name]:eq(' + index +')').addClass('vc_error');
          return;
        }
        if(_.isBoolean(added_param_names[param.param_name]) && added_param_names[param.param_name] == true) {
          $('#vc_atm-params-list [name=param_name]:eq(' + index +')').addClass('vc_error');
          if(!result) result = window.i18nLocaleVcAutomapper.error_param_already_exists.replace(/\%s/, param.param_name);
        }
        added_param_names[param.param_name] = true;
        _.each(fields_required, function(field){
          if(param[field] === '') {
            $('#vc_atm-params-list [name=' + field +']:eq(' + index +')').addClass('vc_error');
            if(!result) result = window.i18nLocaleVcAutomapper.error_enter_required_fields;
          } else if(field == 'param_name' && !param[field].match(/^[a-z0-9_]+$/g)) {
            $('#vc_atm-params-list [name=' + field +']:eq(' + index +')').addClass('vc_error');
            if(!result) result = window.i18nLocaleVcAutomapper.error_wrong_param_name;
          }
        }, this);
      }, this);
      return result || null;
    },
    setContentParam: function(e) {
      var $control = $(e.currentTarget);
      if($control.is(':checked')) {
          this.addParamField({type: 'textarea', heading: 'Content', description: '', param_name: 'content', value: ''});
          this.setParamSorting();
      } else {
          this.removeParamField('content');
      }
      this.setPreview();
    },
    addAllParams: function() {
      _.each(this.model.get('params'), function(param){
        this.addParamField(param);
        if(param.param_name === 'content') $('#vc_atm-is-container').prop('checked', true);
      }, this);
      this.setParamSorting();
    },
    getParams: function() {
      var params = [];
      _.each($('.vc_param'), function(param){
        var $param = $(param);
        params.push({
          param_name: $param.find('[name=param_name]').val(),
          type: $param.find('[name=type]').val(),
          description: $param.find('[name=description]').val(),
          heading: $param.find('[name=heading]').val(),
          value: $param.find('[name=value]').val()
        });
      }, this);
      return params;
    },
    addParam: function(e) {
      e && e.preventDefault();
      this.addParamField({type: '', heading: '', description: '', param_name: '', value: ''});
      this.setPreview();
    },
    removeParamField: function(name) {
      $('.vc_param-name[value="' + name + '"]').parents('.vc_param').remove();
    },
    addParamField: function(attr) {
      var $block = $('<div class="vc_param' + ( attr.param_name === 'content' ? ' vc_content' : '' ) + '"/>').appendTo('#vc_atm-params-list');
      $block.html(_.template(this.param_template_html, attr, template_opti